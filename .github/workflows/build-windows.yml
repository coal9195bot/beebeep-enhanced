name: Build Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Qt 5.15
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build
      shell: cmd
      run: |
        qmake src\src.pro "CONFIG+=release"
        nmake

    - name: Prepare deployment
      shell: pwsh
      run: |
        $qtDir = "$env:QT_ROOT_DIR"
        $qtBin = "$qtDir\bin"
        $qtPlugins = "$qtDir\plugins"
        
        # Find the built exe
        $exe = Get-ChildItem -Path "." -Filter "beebeep.exe" -Recurse | Select-Object -First 1
        if (-not $exe) {
          Write-Host "Searching for any .exe files..."
          Get-ChildItem -Path "." -Filter "*.exe" -Recurse | ForEach-Object { Write-Host $_.FullName }
          Write-Error "beebeep.exe not found"
          exit 1
        }
        Write-Host "Found exe at: $($exe.FullName)"
        
        # Create deploy directory
        New-Item -ItemType Directory -Force -Path "deploy" | Out-Null
        Copy-Item $exe.FullName -Destination "deploy/beebeep.exe"
        
        # Run windeployqt
        & "$qtBin\windeployqt.exe" "deploy\beebeep.exe" --release --no-translations --no-opengl-sw 2>&1
        
        # Also copy VC redist
        $vcRedist = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC\*\x64\Microsoft.VC*.CRT"
        $vcDlls = Get-ChildItem $vcRedist -ErrorAction SilentlyContinue
        if ($vcDlls) {
          foreach ($dll in $vcDlls) {
            Copy-Item $dll.FullName -Destination "deploy/" -ErrorAction SilentlyContinue
          }
          Write-Host "Copied VC runtime DLLs"
        }
        
        # Include vc_redist installer as fallback
        $vcRedistExe = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC\*\vc_redist.x64.exe"
        $installer = Get-ChildItem $vcRedistExe -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($installer) {
          Copy-Item $installer.FullName -Destination "deploy/"
          Write-Host "Copied vc_redist.x64.exe"
        }
        
        Write-Host "`nDeployment contents:"
        Get-ChildItem deploy -Recurse | Format-Table Name, Length

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: beebeep-windows-x64
        path: deploy/
        retention-days: 30
